from utils import *

data = {
  "version": 2,
  "locktime": 0,
  "vin": [
    {
      "txid": "4c5946366b7ddb91d806389e772e42322b5f5f890319d0424e18c44bd21e8cb1",
      "vout": 15,
      "prevout": {
        "scriptpubkey": "76a914adfb8786f19039b78a78a999e04d68348d0571be88ac",
        "scriptpubkey_asm": "OP_DUP OP_HASH160 OP_PUSHBYTES_20 adfb8786f19039b78a78a999e04d68348d0571be OP_EQUALVERIFY OP_CHECKSIG",
        "scriptpubkey_type": "p2pkh",
        "scriptpubkey_address": "1GrwDkr33gT6LuumniYjKEGjTLhsL5kmqC",
        "value": 10060216404
      },
      "scriptsig": "47304402200f3621fdd5f1349a677320e751bde19826836be99ae040029a0d83d070a4b1c9022024a38f71b9a20ab55d19a30f47315f134524a20e471a16029d8997f1a4a8304201210201973a41bb610e199a1fbb208398fbacc732c3658d132dbf9f3a394bedc9a7b5",
      "scriptsig_asm": "OP_PUSHBYTES_71 304402200f3621fdd5f1349a677320e751bde19826836be99ae040029a0d83d070a4b1c9022024a38f71b9a20ab55d19a30f47315f134524a20e471a16029d8997f1a4a8304201 OP_PUSHBYTES_33 0201973a41bb610e199a1fbb208398fbacc732c3658d132dbf9f3a394bedc9a7b5",
      "is_coinbase": False,
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "scriptpubkey": "a9147534725ac9311c0dc3c2fdec382a4f36340e743f87",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 7534725ac9311c0dc3c2fdec382a4f36340e743f OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "3CNjp3kwBdRdhMYn844xHUZHwH8DCAAY9s",
      "value": 8896910
    },
    {
      "scriptpubkey": "a91443e1f348759fb524b1d9a7df3b594b31351e7df987",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 43e1f348759fb524b1d9a7df3b594b31351e7df9 OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "37swshZauGHGTRdiHRQUcNh76sDgChH7Kc",
      "value": 223000000
    },
    {
      "scriptpubkey": "00149636e0377e16fda31da473d2e66ca1b6ace21468",
      "scriptpubkey_asm": "OP_0 OP_PUSHBYTES_20 9636e0377e16fda31da473d2e66ca1b6ace21468",
      "scriptpubkey_type": "v0_p2wpkh",
      "scriptpubkey_address": "bc1qjcmwqdm7zm76x8dyw0fwvm9pk6kwy9rgtvncm3",
      "value": 280195
    },
    {
      "scriptpubkey": "76a914d8a8035e797df5ba84bbabe2d2fb33fb58e0057488ac",
      "scriptpubkey_asm": "OP_DUP OP_HASH160 OP_PUSHBYTES_20 d8a8035e797df5ba84bbabe2d2fb33fb58e00574 OP_EQUALVERIFY OP_CHECKSIG",
      "scriptpubkey_type": "p2pkh",
      "scriptpubkey_address": "1LkaECGybyyKsbuYWNZh4UwTQzEC1fSJ54",
      "value": 470000
    },
    {
      "scriptpubkey": "a914457f3ef86e8d3e28791ff002362327bfd46cf22e87",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 457f3ef86e8d3e28791ff002362327bfd46cf22e OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "382Uyz7sssR9JAPEABQVavtPNf6MnMuvUM",
      "value": 113939
    },
    {
      "scriptpubkey": "a9143ef3bd0f343f1831f7203cc22bdea11208cb901a87",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 3ef3bd0f343f1831f7203cc22bdea11208cb901a OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "37Rsogk5KZLxmu1yMQ2TFssvF6LtYzaPa7",
      "value": 8431131
    },
    {
      "scriptpubkey": "001412490140f1f0f46ada5e40bbb762812963859213",
      "scriptpubkey_asm": "OP_0 OP_PUSHBYTES_20 12490140f1f0f46ada5e40bbb762812963859213",
      "scriptpubkey_type": "v0_p2wpkh",
      "scriptpubkey_address": "bc1qzfyszs837r6x4kj7gzamwc5p993ctysn89j525",
      "value": 585837
    },
    {
      "scriptpubkey": "a9146d043c40a30a5ab360f281ddbb12424cc9df9b2687",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 6d043c40a30a5ab360f281ddbb12424cc9df9b26 OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "3BdSejNSzADoqxoFCGcNbhMpJWaV5iFgQP",
      "value": 82164
    },
    {
      "scriptpubkey": "a914404e38cff36a2b5c2b4f68cafbd2e6a5a79448e287",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 404e38cff36a2b5c2b4f68cafbd2e6a5a79448e2 OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "37Z2smvgyH8vgdtWPK4cfMUERBM2PHiX3L",
      "value": 810022
    },
    {
      "scriptpubkey": "0014b4abb6a180d4a0981603cb0c2afec72faf1251ac",
      "scriptpubkey_asm": "OP_0 OP_PUSHBYTES_20 b4abb6a180d4a0981603cb0c2afec72faf1251ac",
      "scriptpubkey_type": "v0_p2wpkh",
      "scriptpubkey_address": "bc1qkj4mdgvq6jsfs9srevxz4lk897h3y5dv5zsmz0",
      "value": 108436
    },
    {
      "scriptpubkey": "00140e50bbc18e518d18ac48bae1c240f7d2b84a2f5a",
      "scriptpubkey_asm": "OP_0 OP_PUSHBYTES_20 0e50bbc18e518d18ac48bae1c240f7d2b84a2f5a",
      "scriptpubkey_type": "v0_p2wpkh",
      "scriptpubkey_address": "bc1qpegthsvw2xx33tzghtsuys8h62uy5t665yvj45",
      "value": 170705
    },
    {
      "scriptpubkey": "00149531894eb39add57de24ff5c4b0b71e50c3d0113",
      "scriptpubkey_asm": "OP_0 OP_PUSHBYTES_20 9531894eb39add57de24ff5c4b0b71e50c3d0113",
      "scriptpubkey_type": "v0_p2wpkh",
      "scriptpubkey_address": "bc1qj5ccjn4nntw40h3ylawykzm3u5xr6qgnn06my8",
      "value": 374000
    },
    {
      "scriptpubkey": "a9144650a093f13d50882164d6bf78f20059bfa5699187",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 4650a093f13d50882164d6bf78f20059bfa56991 OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "386op3xykFZo4cw3DAT7Y1RUfvaUZ6AuVR",
      "value": 1384000
    },
    {
      "scriptpubkey": "76a914adfb8786f19039b78a78a999e04d68348d0571be88ac",
      "scriptpubkey_asm": "OP_DUP OP_HASH160 OP_PUSHBYTES_20 adfb8786f19039b78a78a999e04d68348d0571be OP_EQUALVERIFY OP_CHECKSIG",
      "scriptpubkey_type": "p2pkh",
      "scriptpubkey_address": "1GrwDkr33gT6LuumniYjKEGjTLhsL5kmqC",
      "value": 9815487885
    }
  ]
}

class Transaction:
    def __init__(self, json_data) -> None:
        data_dict = json.loads(json_data)  # Convert JSON string to dictionary
        self.version = data_dict.get("version")
        self.locktime = data_dict.get("locktime")
        self.vin = data_dict.get("vin")
        self.vout = data_dict.get("vout")
        self.is_coinbase = False

    def print_transaction(self):
        print(f"Version: {self.version}")
        print(f"Locktime: {self.locktime}")
        print("Vin:")
        for input in self.vin:
            print(input)
        print("Vout:")
        for output in self.vout:
            print(output)

    def validate(self):
        # checking the pubscript type
        cnt = 0
        for input in self.vin:
            if input['prevout']['scriptpubkey_type'] != 'p2pkh':
                cnt += 1
        
        if cnt > 0:
            return False

        for idx, input in enumerate(self.vin):
            if input['prevout']['scriptpubkey_type'] == 'p2pkh':
                scriptsig_asm = input['scriptsig_asm'].split(' ')
                prevout_scriptpubkey_asm = input['prevout']['scriptpubkey_asm'].split(' ')

                public_key = scriptsig_asm[-1]
                signature = scriptsig_asm[1]
                pkh = prevout_scriptpubkey_asm[3] # public key hash

                # OP_DUP OP_HASH160 OP_PUSHBYTES_20 <public_key_hash> OP_EQUALVERIFY OP_CHECKSIG
                hashed_public_key = OP_HASH160(public_key)
                if hashed_public_key != pkh:
                    # print('Public key hash mismatch')
                    return False
                
                trimmed_tx = get_trimmed_transaction_p2pkh(self.version, self.locktime, self.vin, self.vout, idx)
                print(trimmed_tx)
                message = hashlib.sha256(bytes.fromhex(trimmed_tx)).digest()
                nn = hashlib.sha256(message).digest().hex()
                print(nn)
                if OP_CHECKSIG(signature, public_key, message)==False:
                    # print('Signature verification failed')
                    return False
                
            elif input['prevout']['scriptpubkey_type'] == 'p2sh':
                scriptsig_asm = input['scriptsig_asm'].split(' ')
                prevout_scriptpubkey_asm = input['prevout']['scriptpubkey_asm'].split(' ')
                redeem_script_asm = input['inner_redeemscript_asm'].split(' ')

                redeem_script = scriptsig_asm[-1]
                sh = prevout_scriptpubkey_asm[2] # script hash

                # OP_HASH160 OP_PUSHBYTES_20 <script_hash> OP_EQUAL
                hashed_redeem_script = OP_HASH160(redeem_script)
                if hashed_redeem_script != sh:
                    # print('Script hash mismatch')
                    return False

                if redeem_script_asm[-1] != 'OP_CHECKMULTISIG':
                    # No further execution needed as it is not a multisig script
                    return False
                
                # OP_PUSHNUM_2 <public_key1> <public_key2> OP_PUSHNUM_2 OP_CHECKMULTISIG

                public_keys = []
                signatures = []

                for i in redeem_script_asm:
                    if i[0:3] == 'OP_':
                        continue
                    assert(len(i) == 66)
                    public_keys.append(i)

                for i in range(len(scriptsig_asm)-1):
                    if scriptsig_asm[i][0:3] == 'OP_':
                        continue
                    signatures.append(scriptsig_asm[i])

                trimmed_tx = get_trimmed_transaction_p2sh(self.version, self.locktime, self.vin, self.vout, idx)
                message = hashlib.sha256(bytes.fromhex(trimmed_tx)).digest()

                n = redeem_script_asm[0].split('_')[-1]
                n = int(n)

                if OP_CHECKMULTISIG(n, signatures, public_keys, message)==False:
                    # print('Multisig verification failed')
                    return False

        total_input = 0
        for input in self.vin:
            total_input += input['prevout']['value']
        total_output = 0
        for output in self.vout:
            total_output += output['value']
        if total_input <= total_output:
            # print('Insufficient funds')
            return False
        print(total_input, total_output)
        return True
            
obj = Transaction(json.dumps(data))
print(obj.validate())

a = '0f3621fdd5f1349a677320e751bde19826836be99ae040029a0d83d070a4b1c9'
b = '24a38f71b9a20ab55d19a30f47315f134524a20e471a16029d8997f1a4a83042'
a = int(a, 16)
b = int(b, 16)
print(f'a is {a} and b is {b}')















































































































'''
p2pkh:
{
  "version": 2,
  "locktime": 0,
  "vin": [
    {
      "txid": "fb7fe37919a55dfa45a062f88bd3c7412b54de759115cb58c3b9b46ac5f7c925",
      "vout": 1,
      "prevout": {
        "scriptpubkey": "76a914286eb663201959fb12eff504329080e4c56ae28788ac",
        "scriptpubkey_asm": "OP_DUP OP_HASH160 OP_PUSHBYTES_20 286eb663201959fb12eff504329080e4c56ae287 OP_EQUALVERIFY OP_CHECKSIG",
        "scriptpubkey_type": "p2pkh",
        "scriptpubkey_address": "14gnf7L2DjBYKFuWb6iftBoWE9hmAoFbcF",
        "value": 433833
      },
      "scriptsig": "4830450221008f619822a97841ffd26eee942d41c1c4704022af2dd42600f006336ce686353a0220659476204210b21d605baab00bef7005ff30e878e911dc99413edb6c1e022acd012102c371793f2e19d1652408efef67704a2e9953a43a9dd54360d56fc93277a5667d",
      "scriptsig_asm": "OP_PUSHBYTES_72 30450221008f619822a97841ffd26eee942d41c1c4704022af2dd42600f006336ce686353a0220659476204210b21d605baab00bef7005ff30e878e911dc99413edb6c1e022acd01 OP_PUSHBYTES_33 02c371793f2e19d1652408efef67704a2e9953a43a9dd54360d56fc93277a5667d",
      "is_coinbase": False,
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "scriptpubkey": "76a9141ef7874d338d24ecf6577e6eadeeee6cd579c67188ac",
      "scriptpubkey_asm": "OP_DUP OP_HASH160 OP_PUSHBYTES_20 1ef7874d338d24ecf6577e6eadeeee6cd579c671 OP_EQUALVERIFY OP_CHECKSIG",
      "scriptpubkey_type": "p2pkh",
      "scriptpubkey_address": "13pjoLcRKqhzPCbJgYW77LSFCcuwmHN2qA",
      "value": 387156
    },
    {
      "scriptpubkey": "76a9142e391b6c47778d35586b1f4154cbc6b06dc9840c88ac",
      "scriptpubkey_asm": "OP_DUP OP_HASH160 OP_PUSHBYTES_20 2e391b6c47778d35586b1f4154cbc6b06dc9840c OP_EQUALVERIFY OP_CHECKSIG",
      "scriptpubkey_type": "p2pkh",
      "scriptpubkey_address": "15DQVhQ7PU6VPsTtvwLxfDsTP4P6A3Z5vP",
      "value": 37320
    }
  ]
}


p2sh:
{
  "version": 2,
  "locktime": 0,
  "vin": [
    {
      "txid": "090ae4cb35569806cc1ac24d0bafb031b8faaa78b87fc91170d8323e3ce8fad9",
      "vout": 0,
      "prevout": {
        "scriptpubkey": "a9142c21151d54bd219dcc4c52e1cb38672dab8e36cc87",
        "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 2c21151d54bd219dcc4c52e1cb38672dab8e36cc OP_EQUAL",
        "scriptpubkey_type": "p2sh",
        "scriptpubkey_address": "35iMHbUZeTssxBodiHwEEkb32jpBfVueEL",
        "value": 13771240
      },
      "scriptsig": "1600147c846a806f4d9e516c9fb2fe364f28eac4e3c3fc",
      "scriptsig_asm": "OP_PUSHBYTES_22 00147c846a806f4d9e516c9fb2fe364f28eac4e3c3fc",
      "witness": [
        "304402205a870b4d3a918c2f26d94127436c7fb0e4484ad25bf7d3ad1db0da350c00ebbb022011a3f26ac25df4c59c3449f9be9c89652163f67025810d7ce96df35fb8e82a2901",
        "03789a9d83798d4cbf688f9969a94084ee1655059e137b43492ee94dc4538790ab"
      ],
      "is_coinbase": False,
      "sequence": 4294967295,
      "inner_redeemscript_asm": "OP_0 OP_PUSHBYTES_20 7c846a806f4d9e516c9fb2fe364f28eac4e3c3fc"
    }
  ],
  "vout": [
    {
      "scriptpubkey": "a914f4ce667f0a7b9439eca3b451b43d8e6dc690662687",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 f4ce667f0a7b9439eca3b451b43d8e6dc6906626 OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "3Q1S4JMASK1pMRAf8QXcQGGMBMxSRq2Nca",
      "value": 4914741
    },
    {
      "scriptpubkey": "a9142c21151d54bd219dcc4c52e1cb38672dab8e36cc87",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 2c21151d54bd219dcc4c52e1cb38672dab8e36cc OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "35iMHbUZeTssxBodiHwEEkb32jpBfVueEL",
      "value": 8852838
    }
  ]
}


  p2sh with multisig:
  {
  "version": 1,
  "locktime": 0,
  "vin": [
    {
      "txid": "0e52722658432b75d8e16a2f6dfca08db0eae50fd7ce32f673cac4bd0b70b544",
      "vout": 1,
      "prevout": {
        "scriptpubkey": "a914e6a63531e03db543823d0a46a4377af7de37153987",
        "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 e6a63531e03db543823d0a46a4377af7de371539 OP_EQUAL",
        "scriptpubkey_type": "p2sh",
        "scriptpubkey_address": "3NiaSz4VomF9ajkNX6H6AdFHyYWnmRWzLQ",
        "value": 645637
      },
      "scriptsig": "00473044022061f5cb2c6a6638e40c7235b888224c6352ea1fe60bd5af6e52b2d77453279ebf0220175360ad1aa5d6f612e19eaa75e155e37a8de938f84985a1bf1220148e20a18301473044022065b884e14705c85b462b41fdfe295f4f0e53baf780840b30c0b90f71833dd64d02206ac04c63828ba80e274c4ff96a03f39f450b4bedcb70b415047ea1ee7c712570014c695221029640a253abbf6252e6d195882262da255d6dd17e66cd8aca2610083f6d4d17812103a553e30733d7a8df6d390d59cc136e2c9d9cf4e808f3b6ab009beae68dd608222103211aec906e232ad96f2d52e849cf2798f4cf2d3d3463f608a7638054542defd653ae",
      "scriptsig_asm": "OP_0 OP_PUSHBYTES_71 3044022061f5cb2c6a6638e40c7235b888224c6352ea1fe60bd5af6e52b2d77453279ebf0220175360ad1aa5d6f612e19eaa75e155e37a8de938f84985a1bf1220148e20a18301 OP_PUSHBYTES_71 3044022065b884e14705c85b462b41fdfe295f4f0e53baf780840b30c0b90f71833dd64d02206ac04c63828ba80e274c4ff96a03f39f450b4bedcb70b415047ea1ee7c71257001 OP_PUSHDATA1 5221029640a253abbf6252e6d195882262da255d6dd17e66cd8aca2610083f6d4d17812103a553e30733d7a8df6d390d59cc136e2c9d9cf4e808f3b6ab009beae68dd608222103211aec906e232ad96f2d52e849cf2798f4cf2d3d3463f608a7638054542defd653ae",
      "is_coinbase": False,
      "sequence": 4294967293,
      "inner_redeemscript_asm": "OP_PUSHNUM_2 OP_PUSHBYTES_33 029640a253abbf6252e6d195882262da255d6dd17e66cd8aca2610083f6d4d1781 OP_PUSHBYTES_33 03a553e30733d7a8df6d390d59cc136e2c9d9cf4e808f3b6ab009beae68dd60822 OP_PUSHBYTES_33 03211aec906e232ad96f2d52e849cf2798f4cf2d3d3463f608a7638054542defd6 OP_PUSHNUM_3 OP_CHECKMULTISIG"
    }
  ],
  "vout": [
    {
      "scriptpubkey": "a9148c5b2b2f7352c6d417f71120b6cf184f1d02543487",
      "scriptpubkey_asm": "OP_HASH160 OP_PUSHBYTES_20 8c5b2b2f7352c6d417f71120b6cf184f1d025434 OP_EQUAL",
      "scriptpubkey_type": "p2sh",
      "scriptpubkey_address": "3EV9juqgMiqshyxT9dBnVjwoSkijRqLeh9",
      "value": 635800
    }
  ]
}


'''